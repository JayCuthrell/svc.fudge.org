name: Build and Deploy Landscape
on:
  push:
    branches:
      - main
permissions:
  contents: write
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. Setup a stable Chrome binary specifically for CI
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        id: setup-chrome

      # 2. Install the landscape2 binary directly (faster than Docker)
      - name: Install landscape2
        run: |
          curl --proto '=https' --tlsv1.2 -LsSf https://github.com/cncf/landscape2/releases/download/v1.1.0/landscape2-installer.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # 3. Build the site (no Docker, so permissions just work)
      - name: Build Landscape
        run: |
          landscape2 build \
            --data-file data.yml \
            --settings-file settings.yml \
            --guide-file guide.yml \
            --games-file games.yml \
            --logos-path logos \
            --output-dir dist
        env:
          # Tell landscape2 where to find the browser we just installed
          CHROME_BIN: ${{ steps.setup-chrome.outputs.chrome-path }}
          
      - name: Add CNAME and .nojekyll
        run: |
          echo "svc.fudge.org" > dist/CNAME
          touch dist/.nojekyll  # This stops GitHub from running Jekyll on your files

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages