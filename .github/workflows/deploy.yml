name: Build and Deploy Landscape
on:
  push:
    branches:
      - main
permissions:
  contents: write
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser libnss3 libgbm1 libasound2

      - name: Build Landscape
        run: |
          # 1. Prepare workspace and pre-create dist with open permissions
          mkdir -p dist
          chmod -R 777 .
          
          # 2. Run the build
          # -w /work is essential for resolving "logos/svc-logo.svg" from settings.yml
          # --net=host and seccomp allow the container to use the host's Chromium
          docker run --rm \
            -v $(pwd):/work \
            -w /work \
            --net=host \
            --security-opt seccomp=unconfined \
            ghcr.io/cncf/landscape2:latest \
            landscape2 build \
              --data-file data.yml \
              --settings-file settings.yml \
              --guide-file guide.yml \
              --games-file games.yml \
              --logos-path logos \
              --output-dir dist
          
          # 3. Fix ownership so the runner user can access and deploy the files
          sudo chown -R $USER:$USER dist

      - name: Add CNAME
        run: echo "svc.fudge.org" > dist/CNAME

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages